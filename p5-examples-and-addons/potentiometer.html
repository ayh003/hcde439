<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdn.jsdelivr.net/npm/p5@1.9.0/lib/p5.js"></script>
    <script src="https://unpkg.com/@gohai/p5.webserial@^1/libraries/p5.webserial.js"></script>

    <title>P5 webserial</title>
    <style>
      html,
      body {
        padding: 0;
        margin: 0;
      }

      canvas {
        display: block;
      }
    </style>
  </head>
  <body>
    <script>
      // int RED = A0;
      // int GREEN = A1;
      // int BLUE = A2;

      // void setup() {
      //   Serial.begin(9600);
      //   pinMode(2, INPUT);
      // }

      // void loop() {
      //   int r = map(analogRead(RED), 512, 1023, 0, 255);
      //   int g = map(analogRead(GREEN), 512, 1023, 0, 255);
      //   int b = map(analogRead(BLUE), 512, 1023, 0, 255);

      //   Serial.print(r);
      //   Serial.print(",");
      //   Serial.print(g);
      //   Serial.print(",");
      //   Serial.println(b);
      //   delay(50);
      // }

      let port;
      let connectBtn;
      let height, width;

      function setup() {
        height = windowHeight;
        width = windowWidth;
        createCanvas(width, height); // Create a canvas that is the size of our browser window
        background(220); // Set the background color

        port = createSerial();

        // in setup, we can open ports we have used previously
        // without user interaction

        let usedPorts = usedSerialPorts();
        if (usedPorts.length > 0) {
          port.open(usedPorts[0], 9600);
        }

        // any other ports can be opened via a dialog after
        // user interaction (see connectBtnClick below)
        connectBtn = createButton("Connect to Arduino");
        connectBtn.position(5, 5);
        connectBtn.mousePressed(connectBtnClick);
      }

      function draw() {
        let str = port.readUntil("\n").trim(); // Read until the newline
        if (str == "") return;

        let [r, g, b] = str.split(",");
        background(Number(r), Number(g), Number(b));

        text(`Red: ${r}`, width / 2 - 200, height / 2);
        text(`Green: ${g}`, width / 2, height / 2);
        text(`BLUE: ${b}`, width / 2 + 200, height / 2);

        checkConnection();
      }

      function checkConnection() {
        // changes button label based on connection status
        if (!port.opened()) {
          connectBtn.html("Connect to Arduino");
        } else {
          connectBtn.html("Disconnect");
        }
      }

      function connectBtnClick() {
        if (!port.opened()) {
          port.open(9600);
        } else {
          port.close();
        }
      }
    </script>
  </body>
</html>
