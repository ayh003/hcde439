<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdn.jsdelivr.net/npm/p5@1.9.0/lib/p5.js"></script>
    <script src="https://unpkg.com/@gohai/p5.webserial@^1/libraries/p5.webserial.js"></script>

    <title>P5 webserial</title>
    <style>
      html,
      body {
        padding: 0;
        margin: 0;
        overflow: hidden;
      }

      canvas {
        display: block;
      }
    </style>
  </head>
  <body>
    <script>
      // int X = A0;
      // int Y = A1;
      // int S = A2;
      // int BTN = 2;

      // int trigPin = 9;
      // int echoPin = 10;
      // long duration;
      // long distance;

      // long lastDistance = 0;

      // void setup() {
      //   Serial.begin(9600);
      //   pinMode(BTN, INPUT);
      //   pinMode(trigPin, OUTPUT);  // Sets the trigPin as an Output
      //   pinMode(echoPin, INPUT);   // Sets the echoPin as an Input
      // }

      // void loop() {

      //   digitalWrite(trigPin, LOW);
      //   delayMicroseconds(2);

      //   digitalWrite(trigPin, HIGH);
      //   delayMicroseconds(10);
      //   digitalWrite(trigPin, LOW);

      //   duration = pulseIn(echoPin, HIGH);
      //   distance = duration * 0.034 / 2;

      //   if (distance > 100) {
      //     distance = lastDistance;
      //   }

      //   lastDistance = distance;

      //   distance = map(distance, 0, 100, 200, 0);

      //   int num = map(analogRead(X), 512, 1023, 0, 30);
      //   int r1 = map(analogRead(Y), 512, 1023, 0, 400);
      //   int r2 = map(analogRead(S), 512, 1023, 0, 500);

      //   Serial.print(r1);
      //   Serial.print(",");
      //   Serial.print(r2);
      //   Serial.print(",");
      //   Serial.print(num);
      //   Serial.print(",");
      //   Serial.print(distance);
      //   Serial.print(",");
      //   Serial.println(digitalRead(BTN));
      //   delay(50);
      // }

      let port;
      let connectBtn;
      let height, width;
      let lastX, lastY;

      function setup() {
        height = windowHeight;
        width = windowWidth;
        lastX = width / 2;
        lastY = height / 2;
        createCanvas(width, height); // Create a canvas that is the size of our browser window
        background(220); // Set the background color

        port = createSerial();

        // in setup, we can open ports we have used previously
        // without user interaction

        let usedPorts = usedSerialPorts();
        if (usedPorts.length > 0) {
          port.open(usedPorts[0], 9600);
        }

        // any other ports can be opened via a dialog after
        // user interaction (see connectBtnClick below)
        connectBtn = createButton("Connect to Arduino");
        connectBtn.position(5, 5);
        connectBtn.mousePressed(connectBtnClick);
      }

      function draw() {
        let str = port.readUntil("\n").trim(); // Read until the newline
        if (str == "") return;

        let [r1, r2, num, radius, button] = str.split(",");

        clear();
        translate(width / 2, height / 2);

        for (let i = 0; i < num; i++) {
          rotate((2 * PI) / num);
          circle(0, r1, radius);
        }

        checkConnection();
      }

      function checkConnection() {
        // changes button label based on connection status
        if (!port.opened()) {
          connectBtn.html("Connect to Arduino");
        } else {
          connectBtn.html("Disconnect");
        }
      }

      function connectBtnClick() {
        if (!port.opened()) {
          port.open(9600);
        } else {
          port.close();
        }
      }
    </script>
  </body>
</html>
